# ============================================================
# Infinity OS — CI/CD + Compliance-as-Code Pipeline
# Runs on every push to main/develop and weekly schedule
# Zero-cost: GitHub Actions free tier (2,000 min/month)
#
# Pipeline stages:
#   1. Type checking & linting
#   2. Unit tests
#   3. Security scanning (OWASP ZAP + Trivy)
#   4. OpenSCAP ISO 27001 compliance check
#   5. Build & deploy to Cloudflare Pages
#   6. Evidence archiving for audit trail
# ============================================================

name: CI · Compliance · Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * 0'   # Weekly Sunday 02:00 UTC — full compliance scan

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

# ============================================================
# JOB 1: Code Quality
# ============================================================
jobs:
  quality:
    name: Type Check & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript type check
        run: pnpm typecheck

      - name: Lint
        run: pnpm lint

# ============================================================
# JOB 2: Unit Tests
# ============================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm test -- --coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

# ============================================================
# JOB 3: Security Scanning
# ============================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: quality
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      # Dependency vulnerability scan
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'   # Don't fail build — report only

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

      # Secret scanning
      - name: Run Gitleaks secret scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      # OWASP Dependency Check
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'infinity-os'
          path: '.'
          format: 'HTML'
          out: 'dependency-check-report'
          args: >
            --enableRetired
            --failOnCVSS 9

      - name: Upload OWASP report
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check
          path: dependency-check-report/
          retention-days: 90

# ============================================================
# JOB 4: ISO 27001 Compliance Scan (OpenSCAP)
# ============================================================
  compliance:
    name: ISO 27001 Compliance
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v4

      # Run OpenSCAP against the codebase configuration
      - name: Install OpenSCAP
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq openscap-scanner ssg-base ssg-debderived

      - name: Run OpenSCAP compliance scan
        run: |
          oscap xccdf eval \
            --profile xccdf_org.ssgproject.content_profile_standard \
            --results compliance/openscap-results-${{ github.sha }}.xml \
            --report compliance/openscap-report-${{ github.sha }}.html \
            /usr/share/xml/scap/ssg/content/ssg-ubuntu2204-ds.xml \
            || true   # Don't fail — collect evidence

      - name: Validate ISO 27001 control mapping
        run: |
          node scripts/validate-controls.js \
            --mapping compliance/control-mapping.csv \
            --results compliance/openscap-results-${{ github.sha }}.xml \
            || echo "Control validation script not yet implemented — skipping"

      - name: Archive compliance evidence
        uses: actions/upload-artifact@v4
        with:
          name: compliance-evidence-${{ github.sha }}
          path: compliance/
          retention-days: 365   # 1 year retention for audit purposes

      # Commit evidence to dedicated branch
      - name: Archive evidence to compliance branch
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "Infinity OS CI"
          git config user.email "ci@infinity-os.dev"
          git fetch origin compliance-evidence 2>/dev/null || true
          git checkout -B compliance-evidence
          git add compliance/
          git commit -m "chore: compliance evidence for ${{ github.sha }} [skip ci]" || true
          git push origin compliance-evidence --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# ============================================================
# JOB 5: Build
# ============================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, security]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_IDENTITY_WORKER_URL: ${{ secrets.VITE_IDENTITY_WORKER_URL }}

      - name: Upload shell build artifact
        uses: actions/upload-artifact@v4
        with:
          name: shell-dist
          path: apps/shell/dist/
          retention-days: 7

# ============================================================
# JOB 6: Deploy to Cloudflare Pages (main branch only)
# ============================================================
  deploy-pages:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: [build, compliance]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://infinity-os.pages.dev
    steps:
      - uses: actions/checkout@v4

      - name: Download shell build
        uses: actions/download-artifact@v4
        with:
          name: shell-dist
          path: apps/shell/dist/

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: infinity-os
          directory: apps/shell/dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

# ============================================================
# JOB 7: Deploy Workers (main branch only)
# ============================================================
  deploy-workers:
    name: Deploy Cloudflare Workers
    runs-on: ubuntu-latest
    needs: [build, compliance]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      matrix:
        worker: [identity, filesystem, registry, notifications, search, ai]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Deploy ${{ matrix.worker }} worker
        run: |
          cd workers/${{ matrix.worker }}
          pnpm exec wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

# ============================================================
# JOB 8: Notify on failure
# ============================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [quality, test, security, compliance, build]
    if: failure()
    steps:
      - name: Create GitHub Issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI Failure: ${context.workflow} on ${context.ref}`,
              body: `## CI Pipeline Failure\n\n**Workflow:** ${context.workflow}\n**Branch:** ${context.ref}\n**Commit:** ${context.sha}\n**Run:** ${context.runId}\n\n[View Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['ci-failure', 'security']
            })
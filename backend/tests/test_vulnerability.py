"""Tests for the Vulnerability Scanner router."""
import pytest
from httpx import AsyncClient
from tests.conftest import get_auth_headers


SAMPLE_REQUIREMENTS_TXT = """fastapi==0.104.1
pydantic==2.5.0
sqlalchemy==2.0.23
httpx==0.25.2
python-jose==3.3.0
bcrypt==4.1.1
"""

SAMPLE_PACKAGE_JSON = """{
  "dependencies": {
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "axios": "1.6.0"
  },
  "devDependencies": {
    "vite": "5.0.0",
    "typescript": "5.3.2"
  }
}"""


@pytest.mark.asyncio
async def test_get_sla_policy(client: AsyncClient):
    """SLA policy endpoint is public."""
    resp = await client.get("/api/v1/vulnerabilities/sla-policy")
    assert resp.status_code == 200
    data = resp.json()
    assert "policy" in data
    assert "critical" in data["policy"]
    assert "high" in data["policy"]
    assert data["policy"]["critical"]["days"] == 7
    assert data["policy"]["high"]["days"] == 14


@pytest.mark.asyncio
async def test_get_ecosystems(client: AsyncClient):
    """Ecosystems endpoint is public."""
    resp = await client.get("/api/v1/vulnerabilities/ecosystems")
    assert resp.status_code == 200
    data = resp.json()
    assert "ecosystems" in data
    assert "PyPI" in data["ecosystems"]
    assert "npm" in data["ecosystems"]


@pytest.mark.asyncio
async def test_scan_requires_auth(client: AsyncClient):
    """Scan endpoint requires authentication."""
    payload = {
        "manifest_content": SAMPLE_REQUIREMENTS_TXT,
        "ecosystem": "PyPI",
    }
    resp = await client.post("/api/v1/vulnerabilities/scan", json=payload)
    assert resp.status_code in (401, 403)


@pytest.mark.asyncio
async def test_scan_invalid_ecosystem(client: AsyncClient, test_user):
    """Invalid ecosystem returns 400."""
    headers = get_auth_headers(test_user)
    payload = {
        "manifest_content": "some content",
        "ecosystem": "InvalidEco",
    }
    resp = await client.post("/api/v1/vulnerabilities/scan", json=payload, headers=headers)
    assert resp.status_code == 400


@pytest.mark.asyncio
async def test_scan_pypi_manifest(client: AsyncClient, test_user):
    """Scan a PyPI requirements.txt manifest."""
    headers = get_auth_headers(test_user)
    payload = {
        "manifest_content": SAMPLE_REQUIREMENTS_TXT,
        "ecosystem": "PyPI",
        "max_packages": 10,
    }
    resp = await client.post("/api/v1/vulnerabilities/scan", json=payload, headers=headers)
    assert resp.status_code == 200
    data = resp.json()
    assert "id" in data
    assert "scanned_at" in data
    assert "ecosystem" in data
    assert data["ecosystem"] == "PyPI"
    assert "package_count" in data
    assert "vulnerability_count" in data
    assert "critical_count" in data
    assert "high_count" in data
    assert "vulnerabilities" in data
    assert isinstance(data["vulnerabilities"], list)


@pytest.mark.asyncio
async def test_scan_npm_manifest(client: AsyncClient, test_user):
    """Scan an npm package.json manifest."""
    headers = get_auth_headers(test_user)
    payload = {
        "manifest_content": SAMPLE_PACKAGE_JSON,
        "ecosystem": "npm",
        "max_packages": 10,
    }
    resp = await client.post("/api/v1/vulnerabilities/scan", json=payload, headers=headers)
    assert resp.status_code == 200
    data = resp.json()
    assert data["ecosystem"] == "npm"
    assert data["package_count"] > 0


@pytest.mark.asyncio
async def test_list_scans(client: AsyncClient, test_user):
    """List recent scans."""
    headers = get_auth_headers(test_user)
    resp = await client.get("/api/v1/vulnerabilities/scans", headers=headers)
    assert resp.status_code == 200
    data = resp.json()
    assert "scans" in data
    assert "total" in data


@pytest.mark.asyncio
async def test_get_vulnerability_summary(client: AsyncClient, test_user):
    """Get vulnerability posture summary."""
    headers = get_auth_headers(test_user)
    resp = await client.get("/api/v1/vulnerabilities/summary", headers=headers)
    assert resp.status_code == 200
    data = resp.json()
    assert "total_scans" in data or "message" in data


@pytest.mark.asyncio
async def test_get_nonexistent_scan(client: AsyncClient, test_user):
    """Getting a non-existent scan returns 404."""
    headers = get_auth_headers(test_user)
    resp = await client.get("/api/v1/vulnerabilities/scans/nonexistent-id", headers=headers)
    assert resp.status_code == 404


@pytest.mark.asyncio
async def test_scan_and_get_remediation(client: AsyncClient, test_user):
    """Scan then get remediation plan."""
    headers = get_auth_headers(test_user)
    # First scan
    payload = {
        "manifest_content": SAMPLE_REQUIREMENTS_TXT,
        "ecosystem": "PyPI",
        "max_packages": 5,
    }
    scan_resp = await client.post("/api/v1/vulnerabilities/scan", json=payload, headers=headers)
    assert scan_resp.status_code == 200
    scan_id = scan_resp.json()["id"]

    # Get remediation plan
    rem_resp = await client.get(f"/api/v1/vulnerabilities/scans/{scan_id}/remediation", headers=headers)
    assert rem_resp.status_code == 200
    data = rem_resp.json()
    assert "scan_id" in data
    assert data["scan_id"] == scan_id
    assert "remediation_plan" in data
    assert "total_items" in data
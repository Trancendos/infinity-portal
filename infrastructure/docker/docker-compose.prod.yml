# ============================================================
# Infinity OS — Production Docker Compose Stack
# Zero-cost self-hosted deployment
#
# Services:
#   - HashiCorp Vault (secrets + crypto-shredding)
#   - Prometheus (metrics)
#   - Grafana (dashboards)
#   - Loki (log aggregation)
#   - Promtail (log shipping)
#   - IPFS (decentralised storage)
#   - Langfuse (AI observability)
#   - Traefik (reverse proxy + TLS)
#
# Usage:
#   cp .env.example .env
#   docker-compose -f infrastructure/docker/docker-compose.prod.yml up -d
# ============================================================

version: '3.9'

networks:
  infinity-internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  infinity-public:
    driver: bridge

volumes:
  vault-data:
  vault-logs:
  prometheus-data:
  grafana-data:
  loki-data:
  ipfs-data:
  langfuse-postgres-data:
  langfuse-clickhouse-data:

# ============================================================
# SECRETS (from .env file — never commit)
# ============================================================
secrets:
  vault_root_token:
    environment: VAULT_ROOT_TOKEN
  grafana_admin_password:
    environment: GRAFANA_ADMIN_PASSWORD

services:

# ============================================================
# TRAEFIK — Reverse Proxy + Automatic TLS
# Zero-cost: Let's Encrypt certificates
# ============================================================
  traefik:
    image: traefik:v3.0
    container_name: infinity-traefik
    restart: unless-stopped
    networks:
      - infinity-public
      - infinity-internal
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/acme.json:/acme.json
    environment:
      - CF_DNS_API_TOKEN=${CLOUDFLARE_DNS_TOKEN}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3

# ============================================================
# HASHICORP VAULT — Secrets + Crypto-Shredding
# ISO 27001: A.10.1 Cryptographic controls
# GDPR: Right to erasure via key deletion
# ============================================================
  vault:
    image: hashicorp/vault:1.15
    container_name: infinity-vault
    restart: unless-stopped
    networks:
      - infinity-internal
    ports:
      - "8200:8200"
    volumes:
      - vault-data:/vault/data
      - vault-logs:/vault/logs
      - ./vault/config.hcl:/vault/config/config.hcl:ro
      - ./vault/policies:/vault/policies:ro
    environment:
      - VAULT_ADDR=http://0.0.0.0:8200
      - VAULT_API_ADDR=http://vault:8200
      - VAULT_CLUSTER_ADDR=http://vault:8201
    cap_add:
      - IPC_LOCK   # Required for memory locking (security)
    command: vault server -config=/vault/config/config.hcl
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vault.rule=Host(`vault.${DOMAIN}`)"
      - "traefik.http.routers.vault.tls.certresolver=letsencrypt"
      - "traefik.http.services.vault.loadbalancer.server.port=8200"

# ============================================================
# VAULT INIT — One-time initialisation job
# Enables Transit engine, creates policies
# ============================================================
  vault-init:
    image: hashicorp/vault:1.15
    container_name: infinity-vault-init
    networks:
      - infinity-internal
    depends_on:
      vault:
        condition: service_healthy
    volumes:
      - ./vault/init.sh:/vault/init.sh:ro
    environment:
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=${VAULT_ROOT_TOKEN}
    command: sh /vault/init.sh
    restart: "no"

# ============================================================
# PROMETHEUS — Metrics Collection
# ISO 27001: A.8.16 Monitoring activities
# ============================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: infinity-prometheus
    restart: unless-stopped
    networks:
      - infinity-internal
    volumes:
      - prometheus-data:/prometheus
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/alerts.yml:/etc/prometheus/alerts.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

# ============================================================
# GRAFANA — Dashboards & Alerting
# ============================================================
  grafana:
    image: grafana/grafana:10.2.0
    container_name: infinity-grafana
    restart: unless-stopped
    networks:
      - infinity-internal
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_SECURITY_ADMIN_USER=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_DOMAIN=${DOMAIN}
      - GF_SERVER_ROOT_URL=https://grafana.${DOMAIN}
      - GF_SMTP_ENABLED=false
      - GF_AUTH_ANONYMOUS_ENABLED=false
    depends_on:
      - prometheus
      - loki
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.${DOMAIN}`)"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

# ============================================================
# LOKI — Log Aggregation
# ISO 27001: A.8.15 Logging
# ============================================================
  loki:
    image: grafana/loki:2.9.0
    container_name: infinity-loki
    restart: unless-stopped
    networks:
      - infinity-internal
    volumes:
      - loki-data:/loki
      - ./monitoring/loki.yml:/etc/loki/local-config.yaml:ro
    command: -config.file=/etc/loki/local-config.yaml
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

# ============================================================
# PROMTAIL — Log Shipping to Loki
# ============================================================
  promtail:
    image: grafana/promtail:2.9.0
    container_name: infinity-promtail
    restart: unless-stopped
    networks:
      - infinity-internal
    volumes:
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./monitoring/promtail.yml:/etc/promtail/config.yml:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki

# ============================================================
# IPFS — Decentralised File Storage
# Private swarm — no public IPFS network
# ============================================================
  ipfs:
    image: ipfs/kubo:v0.25.0
    container_name: infinity-ipfs
    restart: unless-stopped
    networks:
      - infinity-internal
    volumes:
      - ipfs-data:/data/ipfs
      - ./ipfs/swarm.key:/data/ipfs/swarm.key:ro
    environment:
      - LIBP2P_FORCE_PNET=1   # Force private network — reject public peers
    ports:
      - "4001:4001"   # Swarm (internal only — firewall this)
      - "5001:5001"   # API (internal only)
    command: >
      sh -c "
        ipfs config --json API.HTTPHeaders.Access-Control-Allow-Origin '[&quot;http://localhost:3000&quot;]' &&
        ipfs config --json Swarm.EnableRelayHop false &&
        ipfs config --json Bootstrap null &&
        ipfs daemon --migrate=true
      "
    healthcheck:
      test: ["CMD", "ipfs", "id"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

# ============================================================
# LANGFUSE — AI Observability & Tracing
# ISO 27001: A.8.16 Monitoring (AI decisions)
# ============================================================
  langfuse-postgres:
    image: postgres:15-alpine
    container_name: infinity-langfuse-db
    restart: unless-stopped
    networks:
      - infinity-internal
    volumes:
      - langfuse-postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=langfuse
      - POSTGRES_USER=langfuse
      - POSTGRES_PASSWORD=${LANGFUSE_DB_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U langfuse"]
      interval: 10s
      timeout: 5s
      retries: 5

  langfuse:
    image: langfuse/langfuse:2
    container_name: infinity-langfuse
    restart: unless-stopped
    networks:
      - infinity-internal
    depends_on:
      langfuse-postgres:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql://langfuse:${LANGFUSE_DB_PASSWORD}@langfuse-postgres:5432/langfuse
      - NEXTAUTH_SECRET=${LANGFUSE_NEXTAUTH_SECRET}
      - NEXTAUTH_URL=https://langfuse.${DOMAIN}
      - SALT=${LANGFUSE_SALT}
      - LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES=false
      - TELEMETRY_ENABLED=false   # Privacy: no telemetry
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.langfuse.rule=Host(`langfuse.${DOMAIN}`)"
      - "traefik.http.routers.langfuse.tls.certresolver=letsencrypt"
      - "traefik.http.services.langfuse.loadbalancer.server.port=3000"

# ============================================================
# BACKUP — Automated daily backups
# ISO 27001: A.12.3 Backup
# ============================================================
  backup:
    image: alpine:3.19
    container_name: infinity-backup
    restart: unless-stopped
    networks:
      - infinity-internal
    volumes:
      - vault-data:/backup/vault:ro
      - prometheus-data:/backup/prometheus:ro
      - grafana-data:/backup/grafana:ro
      - ./scripts/backup.sh:/backup.sh:ro
    environment:
      - BACKUP_RETENTION_DAYS=30
      - RCLONE_CONFIG=${RCLONE_CONFIG}
    command: >
      sh -c "
        apk add --no-cache rclone tar gzip &&
        crond -f -d 8
      "
    # Cron: daily at 01:00 UTC
    # Add to crontab: 0 1 * * * /backup.sh